C51 COMPILER V9.00   PLL                                                                   06/21/2020 20:17:33 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE PLL
OBJECT MODULE PLACED IN .\Objects\pll.obj
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE pll.c LARGE BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\pll.lst) OBJECT(.\Ob
                    -jects\pll.obj)

line level    source

   1          #include "stc8.h"
   2          #include "pll.h"
   3          #include "utily.h"
   4          
   5          //∑¢…‰4300MHz
   6          double tx_freq = 4300.0;
   7          unsigned int tx_nint_ratio = 430/*430*/;
   8          unsigned char tx_r_ratio = 4/*10*/;        
   9          unsigned long tx_nfrac_ratio = 0;
  10          unsigned long tx_reg_var[6] = {0x1f86ff,0xf6800a,0xe00000,0x1ae,0x0};
  11          
  12          //Ω” ’4289.2MHz
  13          double rx_freq = 4289.2;
  14          unsigned int rx_nint_ratio = 428/*430*/;
  15          unsigned char rx_r_ratio = 4/*10*/;        
  16          unsigned long rx_nfrac_ratio = 15435038;
  17          unsigned long rx_reg_var[6] = {0x1f86ff,0xf6800a,0xe00000,0x1ae,0x0};
  18          
  19          sbit tx_lock = P0^2;
  20          sbit tx_dout = P4^3;
  21          sbit tx_le = P0^6;
  22          sbit tx_clk = P0^5;
  23          
  24          sbit rx_lock = P2^6;
  25          sbit rx_dout = P2^7;
  26          sbit rx_clk = P0^0;
  27          sbit rx_le = P0^1;
  28          
  29          void PLL_Reset()
  30          {
  31   1              rx_clk = 0;
  32   1              tx_clk = 0;
  33   1              rx_dout = 0;
  34   1              tx_dout = 0;
  35   1              rx_le = 1;
  36   1              tx_le = 1;
  37   1      }
  38          
  39          void PLL_Init()
  40          {
  41   1              //tx
  42   1              //reference div ratio
  43   1              tx_reg_var[1] &= 0xffc000;
  44   1              tx_reg_var[1] |= tx_r_ratio;
  45   1      
  46   1              //n.int div ratio
  47   1              tx_reg_var[3] &= 0xff0000;
  48   1              tx_reg_var[3] |= tx_nint_ratio;
  49   1      
  50   1              //n.frac div ratio
  51   1              tx_reg_var[4] &= 0x000000;
  52   1              tx_reg_var[4] |= tx_nfrac_ratio;
  53   1      
  54   1      
C51 COMPILER V9.00   PLL                                                                   06/21/2020 20:17:33 PAGE 2   

  55   1              //rx
  56   1              //reference div ratio
  57   1              rx_reg_var[1] &= 0xffc000;
  58   1              rx_reg_var[1] |= rx_r_ratio;
  59   1      
  60   1              //n.int div ratio
  61   1              rx_reg_var[3] &= 0xff0000;
  62   1              rx_reg_var[3] |= rx_nint_ratio;
  63   1      
  64   1              //n.frac div ratio
  65   1              rx_reg_var[4] &= 0x000000;
  66   1              rx_reg_var[4] |= rx_nfrac_ratio;
  67   1      }
  68          
  69          void PLL_Adjust(char var)
  70          {
  71   1              double temp;
  72   1      
  73   1              tx_freq += var;
  74   1              temp = tx_freq / 10.0;
  75   1              tx_nint_ratio = temp;
  76   1      
  77   1              temp =  temp - tx_nint_ratio;
  78   1              temp =  temp * 4096.0;
  79   1              temp *= 4096.0; 
  80   1              tx_nfrac_ratio = temp;
  81   1      
  82   1      
  83   1              rx_freq += var;
  84   1              temp = rx_freq / 10.0;
  85   1              rx_nint_ratio = temp;
  86   1      
  87   1              temp =  temp - rx_nint_ratio;
  88   1              temp =  temp * 4096.0;
  89   1              temp *= 4096.0; 
  90   1              rx_nfrac_ratio = temp;
  91   1      
  92   1              PLL_Reset();
  93   1              PLL_Init();
  94   1              PLL_Tx_Config();
  95   1              PLL_Rx_Config();
  96   1      }
  97          
  98          void PLL_WriteTxReg(unsigned char addr,unsigned long var)
  99          {
 100   1              unsigned char i;
 101   1              unsigned long content = addr,temp;
 102   1              content = content << 24;
 103   1              content |= var;
 104   1              
 105   1              tx_le = 0;
 106   1              
 107   1              for(i=0;i<27;i++)
 108   1              {
 109   2                      temp = (0x04000000 >> i);
 110   2                      
 111   2                      tx_clk = 0;
 112   2                      
 113   2                      if((content & temp) == temp)
 114   2                              tx_dout = 1;
 115   2                      else tx_dout = 0;
 116   2                      
C51 COMPILER V9.00   PLL                                                                   06/21/2020 20:17:33 PAGE 3   

 117   2                      tx_clk = 1;
 118   2              }       
 119   1              
 120   1              tx_clk = 0;
 121   1              tx_dout = 0;
 122   1              tx_le = 1;
 123   1      }
 124          
 125          void PLL_WriteRxReg(unsigned char addr,unsigned long var)
 126          {
 127   1              unsigned char i;
 128   1              unsigned long content = addr,temp;
 129   1              content = content << 24;
 130   1              content |= var;
 131   1              
 132   1              rx_le = 0;
 133   1              
 134   1              for(i=0;i<27;i++)
 135   1              {
 136   2                      temp = (0x04000000 >> i);
 137   2                      
 138   2                      rx_clk = 0;
 139   2                      
 140   2                      if((content & temp) == temp)
 141   2                              rx_dout = 1;
 142   2                      else rx_dout = 0;
 143   2                      
 144   2                      rx_clk = 1;
 145   2              }       
 146   1              
 147   1              rx_clk = 0;
 148   1              rx_dout = 0;
 149   1              rx_le = 1;
 150   1      }
 151          
 152          void PLL_Tx_Config()
 153          {
 154   1              unsigned char i;
 155   1              for(i=0;i<5;i++)
 156   1              {
 157   2                      PLL_WriteTxReg(i, tx_reg_var[i]);
 158   2      
 159   2                      tx_le = 1;
 160   2                      delay_ms(1);
 161   2                      tx_le = 0;
 162   2                      delay_ms(1);
 163   2                      tx_le = 1;
 164   2              }
 165   1      }
 166          
 167          void PLL_Rx_Config()
 168          {
 169   1              unsigned char i;
 170   1              for(i=0;i<5;i++)
 171   1              {
 172   2                      PLL_WriteRxReg(i, rx_reg_var[i]);
 173   2      
 174   2                      rx_le = 1;
 175   2                      delay_ms(1);
 176   2                      rx_le = 0;
 177   2                      delay_ms(1);
 178   2                      rx_le = 1;
C51 COMPILER V9.00   PLL                                                                   06/21/2020 20:17:33 PAGE 4   

 179   2              }
 180   1      }
 181          
 182          signed char PLL_IsTxLocked()
 183          {
 184   1              return tx_lock;
 185   1      }
 186          
 187          signed char PLL_IsRxLocked()
 188          {
 189   1              return rx_lock;
 190   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1420    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     70      35
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
